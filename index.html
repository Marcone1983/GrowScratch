<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grow$cratch NFT Telegram Mini App</title>
    <script type="module" src="main.js"></script>
</head>
<body>

    

<div id="splash">
  <!-- Logo Container -->
  <div id="logo-container">
    <img id="logo-image" src="1000216417.png" alt="Grow$cratch Logo">
    <div class="logo-star" style="animation-delay: 0s;">‚≠ê</div>
    <div class="logo-star" style="animation-delay: 1s;">‚ú®</div>
    <div class="logo-star" style="animation-delay: 2s;">üí´</div>
    <div class="logo-star" style="animation-delay: 3s;">üåü</div>
  </div>
  
  <div id="progress-bar">
    <div id="progress-fill"></div>
    <div id="coin">ü™ô</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <h1 class="text-xl font-bold mb-2">Grow$cratch</h1>
  <img src="1000216417.png" alt="Grow$cratch Logo" class="mx-auto h-12 mb-4">
  <p>Benvenuto <span id="username"></span>!</p>
  <div class="canvas-container" id="canvas-container">
    <div id="prize-container">
      <div id="prize-name-display"></div>
    </div>
    <canvas id="scratch-canvas"></canvas>
  </div>
  <div class="mt-4 space-y-2">
    <button id="playButton" class="bg-green-600 px-6 py-2 rounded-xl hover:bg-green-500 transition">Gioca con 25 Stars üåü</button>
    <button id="walletButton" class="bg-blue-600 px-6 py-2 rounded-xl hover:bg-blue-500 transition hidden">Paga 1 TON ü™ô</button>
  </div>
  <div id="result-text" class="mt-4 text-xl font-bold text-yellow-400 hidden"></div>
</div>

<!-- Win Overlay -->
<div id="win-overlay"></div>
<div id="win-message"></div>

<script>
  
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

function playWinSound() {
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime);
    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1);
    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2);
    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    oscillator.start(audioCtx.currentTime);
    oscillator.stop(audioCtx.currentTime + 0.5);
}

function playLoseSound() {
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
    oscillator.frequency.setValueAtTime(200, audioCtx.currentTime + 0.3);
    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    oscillator.start(audioCtx.currentTime);
    oscillator.stop(audioCtx.currentTime + 0.5);
}

function playJackpotSound() {
    for(let i = 0; i < 5; i++) {
        setTimeout(() => {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.setValueAtTime(523.25 + (i * 100), audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.3);
        }, i * 100);
    }
}

function createConfetti() {
    for(let i = 0; i < 50; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.top = '-10px';
            confetti.style.backgroundColor = ['#ffd700', '#ff9500', '#ffed4e', '#ff6b6b', '#4ecdc4'][Math.floor(Math.random() * 5)];
            confetti.style.animation = `confettiFall ${2 + Math.random() * 2}s linear forwards`;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 4000);
        }, i * 50);
    }
}

function createCelebrationStars(x, y) {
    for(let i = 0; i < 12; i++) {
        const star = document.createElement('div');
        star.className = 'celebration-star';
        star.textContent = '‚≠ê';
        star.style.left = x + 'px';
        star.style.top = y + 'px';
        const angle = (i / 12) * Math.PI * 2;
        const distance = 150;
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance;
        star.style.setProperty('--tx', tx + 'px');
        star.style.setProperty('--ty', ty + 'px');
        document.body.appendChild(star);
        setTimeout(() => star.remove(), 1000);
    }
}

const splash = document.getElementById('splash');
for(let i = 0; i < 30; i++) {
    const particle = document.createElement('div');
    particle.className = 'splash-particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.top = Math.random() * 100 + '%';
    particle.style.animationDelay = Math.random() * 3 + 's';
    particle.style.animationDuration = (2 + Math.random() * 2) + 's';
    splash.appendChild(particle);
}

const progressFill = document.getElementById('progress-fill');
const coin = document.getElementById('coin');
const progressBar = document.getElementById('progress-bar');

let progress = 0;
const splashInterval = setInterval(() => {
    progress += Math.random()*3 + 1.5;
    if(progress>=100) progress=100;
    progressFill.style.width = (100 - progress) + '%'; // La barra di riempimento si riduce per rivelare il giallo
    coin.style.left = `calc(${progress}% - 28px)`;
    
    // Crea particelle di grattata
    if(progress > 5 && Math.random() > 0.5) {
        const particle = document.createElement('div');
        particle.className = 'scratch-particle';
        const rect = progressBar.getBoundingClientRect();
        particle.style.left = (rect.left + (progress/100) * rect.width) + 'px';
        particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
        document.body.appendChild(particle);
        
        const dx = (Math.random() - 0.5) * 40;
        const dy = (Math.random() - 0.5) * 40;
        let life = 0;
        const particleInterval = setInterval(() => {
            life++;
            particle.style.transform = `translate(${dx * life / 10}px, ${dy * life / 10}px) scale(${1 - life/10})`;
            particle.style.opacity = 1 - life / 10;
            if(life > 10) {
                clearInterval(particleInterval);
                particle.remove();
            }
        }, 16);
    }
    
    if(progress>=100){
        clearInterval(splashInterval);
        setTimeout(()=>{ 
            splash.style.transition = 'opacity 0.5s ease';
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.style.display='none'; 
                document.getElementById('app').style.display='block'; 
                initApp();
            }, 500);
        },500);
    }
},30);
let user = { first_name:"Guest", id:0 };
if(window.Telegram?.WebApp?.initDataUnsafe?.user) user = window.Telegram.WebApp.initDataUnsafe.user;
document.getElementById('username').textContent = user.first_name;

const PRIZES = [
    {name:'Entrata gratis Live', type:'reward', probability:0.15},
    {name:'Entrata gratis Lezione', type:'reward', probability:0.15},
    {name:'10% di sconto Grow Shop', type:'reward', probability:0.15},
    {name:'10% di sconto God Shop', type:'reward', probability:0.075},
    {name:'NFT Seed', type:'reward', probability:0.075},
    {name:'Skin Piece', type:'collection', probability:0.10},
    {name:'God Voice Token', type:'reward', probability:0.05},
    {name:'1 mese pubblicit√† gratuita', type:'reward', probability:0.05},
    {name:'G-ELITE Jackpot', type:'jackpot', probability:0.000001},
    {name:'Hai perso', type:'lose', probability:0.20}
];
let currentPrize = null;
let scratchComplete = false;
let scratching = false;

function drawPrize() {
    const rand = Math.random();
    let cumulative = 0;
    for(let p of PRIZES){
        cumulative += p.probability;
        if(rand<=cumulative) return p;
    }
    return {name:'Hai perso', type:'lose'};
}

const canvas = document.getElementById('scratch-canvas');
const ctx = canvas.getContext('2d');
const container = document.getElementById('canvas-container');
const prizeDisplay = document.getElementById('prize-name-display');
const resultText = document.getElementById('result-text');
const walletButton = document.getElementById('walletButton');
const winOverlay = document.getElementById('win-overlay');
const winMessage = document.getElementById('win-message');
const prizeContainer = document.getElementById('prize-container');

function resizeCanvas(){ canvas.width=container.clientWidth; canvas.height=container.clientHeight; }
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function drawOverlay(){
    ctx.globalCompositeOperation='source-over';
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#555';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='white';
    ctx.font='bold 20px Inter';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText('GRATTA PER SCOPRIRE', canvas.width/2, canvas.height/2);
    ctx.globalCompositeOperation='destination-out';
}

canvas.addEventListener("mousedown",()=>scratching=true);
canvas.addEventListener("mouseup",()=>{ scratching=false; checkScratchCompletion(); });
canvas.addEventListener("mousemove",(e)=>{if(!scratching||scratchComplete) return; createScratch(e); });

canvas.addEventListener("touchstart",(e)=>{ e.preventDefault(); scratching=true; });
canvas.addEventListener("touchend",(e)=>{ e.preventDefault(); scratching=false; checkScratchCompletion(); });
canvas.addEventListener("touchmove",(e)=>{ e.preventDefault(); if(!scratching||scratchComplete) return; createScratch(e.touches[0]); });

function createScratch(e){
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.pageX) - rect.left;
    const y = (e.clientY || e.pageY) - rect.top;
    ctx.beginPath();
    ctx.arc(x,y,30,0,Math.PI*2);
    ctx.fill();
    createParticle(e.clientX || e.pageX, e.clientY || e.pageY);
}

function createParticle(x,y){
    const particle = document.createElement('div');
    particle.className='particle';
    document.body.appendChild(particle);
    particle.style.left=x+'px';
    particle.style.top=y+'px';
    const dx=(Math.random()-0.5)*30, dy=(Math.random()-0.5)*30;
    let life=0;
    const interval=setInterval(()=>{
        life++;
        particle.style.transform=`translate(${dx*life/10}px,${dy*life/10}px) scale(${1 - life/15})`;
        particle.style.opacity=1-life/10;
        if(life>10){ clearInterval(interval); particle.remove(); }
    },16);
}

function checkScratchCompletion(){
    const pixels = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    let cleared=0;
    for(let i=3;i<pixels.length;i+=4) if(pixels[i]===0) cleared++;
    const percent=cleared/(pixels.length/4)*100;
    if(percent>70){
        scratchComplete=true;
        prizeDisplay.style.display='block';
        prizeDisplay.textContent=currentPrize.name;
        walletButton.classList.remove('hidden');
        
        prizeContainer.classList.add('win-animation');
        
        if(currentPrize.type === 'lose') {
            resultText.textContent='Hai perso! üò¢';
            playLoseSound();
        } else if(currentPrize.type === 'jackpot') {
            resultText.textContent='üéâ JACKPOT! üéâ Paga 1 TON per rivelare il premio';
            playJackpotSound();
            createConfetti();
            showWinAnimation('üéâ JACKPOT! üéâ');
            createCelebrationStars(window.innerWidth/2, window.innerHeight/2);
        } else {
            resultText.textContent='Hai vinto! Paga 1 TON per rivelare il premio';
            playWinSound();
            createConfetti();
            showWinAnimation('üéâ HAI VINTO! üéâ');
            createCelebrationStars(window.innerWidth/2, window.innerHeight/2);
        }
        
        resultText.classList.remove('hidden');
        canvas.style.opacity=0;
    }
}

function showWinAnimation(message) {
    winOverlay.style.display = 'block';
    winMessage.textContent = message;
    winMessage.style.display = 'block';
    
    setTimeout(() => {
        winOverlay.style.display = 'none';
        winMessage.style.display = 'none';
    }, 3000);
}

document.getElementById('playButton').addEventListener("click",(e)=>{
    e.preventDefault(); // Impedisce il ricaricamento della pagina
    
    // Logica TWA: apre il link per il pagamento delle 25 Stars
    const starsLink=`https://t.me/GrowScratch_bot?startapp=buy_25stars_${user.id}`;
    window.Telegram.WebApp.openLink(starsLink);
});

});

walletButton.addEventListener("click",()=>{
    if(!currentPrize||currentPrize.type==='lose') return;
    
    // Logica TWA: apre il link per il minting NFT (pagamento 1 TON)
    const tonLink=`https://t.me/GrowScratch_bot?startapp=mint_nft_1ton_${user.id}_${encodeURIComponent(currentPrize.name)}`;
    window.Telegram.WebApp.openLink(tonLink);
    window.Telegram.WebApp.showAlert(`Pagamento 1 TON avviato per mintare l'NFT: ${currentPrize.name}`);
});

function initApp(){ 
    window.Telegram.WebApp.ready(); 
    window.Telegram.WebApp.expand(); 
    drawOverlay(); 
    // Nascondi l'elemento giallo all'avvio
    prizeDisplay.style.display='none'; 
}
</script>
>>>>>>> e899306 (Fix: Audit finale e correzione bug. Eliminato il quadrato giallo e ripristinato il flusso TWA corretto.)
</body>
</html>