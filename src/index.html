<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grow$cratch NFT</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');

  body, html { margin:0; padding:0; height:100%; font-family: 'Inter', sans-serif; background: #0f0f0f; color:white; overflow:hidden; }
  /* --- SPLASH --- */
  #splash { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#0f0f0f; z-index:100; }
  #logo { font-size:3rem; font-weight:900; color:gold; text-shadow:0 0 10px #ffd700,0 0 20px #ffa500; margin-bottom:40px; }
  #progress-bar { width:80%; height:20px; background:#333; border-radius:10px; overflow:hidden; position:relative; }
  #progress-fill { height:100%; background:linear-gradient(90deg, gold, orange); width:0%; position:relative; }
  #coin { position:absolute; top:-10px; left:0; width:40px; height:40px; background:gold; border-radius:50%; box-shadow:0 0 10px yellow; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff; }

  /* --- APP --- */
  #app { display:none; text-align:center; padding:4px; }
  .canvas-container { position:relative; max-width:400px; margin:20px auto; aspect-ratio:1/1; overflow:hidden; border-radius:16px; }
  #scratch-canvas { position:absolute; top:0; left:0; width:100%; height:100%; border-radius:16px; cursor:pointer; transition:opacity 0.5s ease; }
  #prize-container { width:100%; height:100%; background-image:url('1000214841.jpg'); background-size:cover; background-position:center; border-radius:16px; display:flex; align-items:center; justify-content:center; transition:transform 0.5s ease; }
  #prize-name-display { display:none; background:rgba(0,0,0,0.7); padding:10px 16px; border-radius:12px; font-weight:900; font-size:1.6rem; text-shadow:0 0 10px gold; animation: glow 1s ease infinite alternate; }
  @keyframes glow { from{ text-shadow:0 0 10px gold,0 0 20px gold; } to{ text-shadow:0 0 20px gold,0 0 40px gold; } }

  /* PARTICELLE */
  .particle { position:absolute; width:6px; height:6px; border-radius:50%; background:gold; pointer-events:none; }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div id="logo">Grow$cratch</div>
  <div id="progress-bar">
    <div id="progress-fill"></div>
    <div id="coin">ðŸª™</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <h1 class="text-3xl font-bold mb-4">GrowScratch NFT ðŸŽ°</h1>
  <p>Benvenuto <span id="username"></span>!</p>
  <div class="canvas-container" id="canvas-container">
    <div id="prize-container">
      <div id="prize-name-display"></div>
    </div>
    <canvas id="scratch-canvas"></canvas>
  </div>
  <div class="mt-4 space-y-2">
    <button id="playButton" class="bg-green-600 px-6 py-2 rounded-xl hover:bg-green-500 transition">Gioca con 25 Stars ðŸŒŸ</button>
    <button id="walletButton" class="bg-blue-600 px-6 py-2 rounded-xl hover:bg-blue-500 transition hidden">Paga 1 TON ðŸª™</button>
  </div>
  <div id="result-text" class="mt-4 text-xl font-bold text-yellow-400 hidden"></div>
</div>

<script>
// --- SPLASH ANIMATION ---
const splash = document.getElementById('splash');
const progressFill = document.getElementById('progress-fill');
const coin = document.getElementById('coin');

let progress = 0;
const splashInterval = setInterval(() => {
    progress += Math.random()*3 + 1; // velocitÃ  casuale
    if(progress>=100) progress=100;
    progressFill.style.width = progress + '%';
    coin.style.left = `calc(${progress}% - 20px)`;
    if(progress>=100){
        clearInterval(splashInterval);
        setTimeout(()=>{ splash.style.display='none'; document.getElementById('app').style.display='block'; initApp(); },500);
    }
},30);

// --- UTENTE ---
let user = { first_name:"Guest", id:0 };
if(window.Telegram?.WebApp?.initDataUnsafe?.user) user = window.Telegram.WebApp.initDataUnsafe.user;
document.getElementById('username').textContent = user.first_name;

// --- PREMI ---
const PRIZES = [
    {name:'Entrata gratis Live', type:'reward', probability:0.15},
    {name:'Entrata gratis Lezione', type:'reward', probability:0.15},
    {name:'10% di sconto Grow Shop', type:'reward', probability:0.15},
    {name:'10% di sconto God Shop', type:'reward', probability:0.075},
    {name:'NFT Seed', type:'reward', probability:0.075},
    {name:'Skin Piece', type:'collection', probability:0.10},
    {name:'God Voice Token', type:'reward', probability:0.05},
    {name:'1 mese pubblicitÃ  gratuita', type:'reward', probability:0.05},
    {name:'G-ELITE Jackpot', type:'jackpot', probability:0.000001},
    {name:'Hai perso', type:'lose', probability:0.20}
];
let currentPrize = null;
let scratchComplete = false;

function drawPrize() {
    const rand = Math.random();
    let cumulative = 0;
    for(let p of PRIZES){
        cumulative += p.probability;
        if(rand<=cumulative) return p;
    }
    return {name:'Hai perso', type:'lose'};
}

// --- CANVAS ---
const canvas = document.getElementById('scratch-canvas');
const ctx = canvas.getContext('2d');
const container = document.getElementById('canvas-container');
const prizeDisplay = document.getElementById('prize-name-display');
const resultText = document.getElementById('result-text');
const walletButton = document.getElementById('walletButton');

function resizeCanvas(){ canvas.width=container.clientWidth; canvas.height=container.clientHeight; }
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function drawOverlay(){
    ctx.globalCompositeOperation='source-over';
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#555';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='white';
    ctx.font='bold 20px Inter';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText('GRATTA PER SCOPRIRE', canvas.width/2, canvas.height/2);
    ctx.globalCompositeOperation='destination-out';
}

canvas.addEventListener("mousedown",()=>scratching=true);
canvas.addEventListener("mouseup",()=>{ scratching=false; checkScratchCompletion(); });
canvas.addEventListener("mousemove",(e)=>{if(!scratching||scratchComplete) return; createScratch(e); });

function createScratch(e){
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX-rect.left;
    const y = e.clientY-rect.top;
    ctx.beginPath();
    ctx.arc(x,y,30,0,Math.PI*2);
    ctx.fill();
    createParticle(x,y);
}

// --- PARTICELLE ---
function createParticle(x,y){
    const particle = document.createElement('div');
    particle.className='particle';
    document.body.appendChild(particle);
    particle.style.left=x+'px';
    particle.style.top=y+'px';
    const dx=(Math.random()-0.5)*20, dy=(Math.random()-0.5)*20;
    let life=0;
    const interval=setInterval(()=>{
        life++;
        particle.style.transform=`translate(${dx*life/10}px,${dy*life/10}px)`;
        particle.style.opacity=1-life/10;
        if(life>10){ clearInterval(interval); particle.remove(); }
    },16);
}

function checkScratchCompletion(){
    const pixels = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    let cleared=0;
    for(let i=3;i<pixels.length;i+=4) if(pixels[i]===0) cleared++;
    const percent=cleared/(pixels.length/4)*100;
    if(percent>70){
        scratchComplete=true;
        prizeDisplay.style.display='block';
        prizeDisplay.textContent=currentPrize.name;
        walletButton.classList.remove('hidden');
        resultText.textContent=(currentPrize.type==='lose')?'Hai perso! ðŸ˜¢':'Hai vinto! Paga 1 TON per rivelare il premio';
        resultText.classList.remove('hidden');
        canvas.style.opacity=0;
    }
}

// --- BUTTONS ---
document.getElementById('playButton').addEventListener("click",()=>{
    currentPrize=drawPrize();
    scratchComplete=false;
    prizeDisplay.style.display='none';
    walletButton.classList.add('hidden');
    resultText.classList.add('hidden');
    canvas.style.opacity=1;
    drawOverlay();
    const starsLink=`https://t.me/GrowScratch_bot?startapp=buy_25stars_${user.id}`;
    window.Telegram.WebApp.openLink(starsLink);
});

walletButton.addEventListener("click",()=>{
    if(!currentPrize||currentPrize.type==='lose') return;
    const tonLink=`https://t.me/GrowScratch_bot?startapp=buy_1ton_${user.id}`;
    window.Telegram.WebApp.openLink(tonLink);
    window.Telegram.WebApp.showAlert(`Pagamento 1 TON avviato per riscattare: ${currentPrize.name}`);
});

// --- INIT ---
function initApp(){ window.Telegram.WebApp.ready(); window.Telegram.WebApp.expand(); drawOverlay(); }
</script>
</body>
</html>
